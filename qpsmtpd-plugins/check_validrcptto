use Qpsmtpd::DSN();

sub hook_rcpt {
	my ($self, $transaction, $recipient) = @_;
	my $user        = lc $recipient->user;
	my $host        = lc $recipient->host;
	my $delivery    = "$user\@$host";

	# This means that it is either a local address or has auth'd.
	if ($self->qp->connection->relay_client) {
		return (OK);
	}

	# run the script that checks the email address
	`sudo -u vmail is_validrcptto "$delivery"`;
	my $exit_code = $? >> 8;

	if ($exit_code == 0) {
		return (OK);
	}

	# This is when the connection to the database failed
	if ($exit_code == 255) {
		return Qpsmtpd::DSN->sys_unspecified("Unable to check address, try again later");
	}

	# This is the exit code when the account is disabled
	if ($exit_code == 2) {
		return Qpsmtpd::DSN->mbox_disabled;
	}

	if ($exit_code == 4) {
		return Qpsmtpd::DSN->mbox_full("User over quota");
	}

	if ($exit_code == 5) {
		return Qpsmtpd::DSN->mbox_full("Domain over quota");
	}

	return (DECLINED);
}

# vim: ft=perl
